# 用量提醒说明文档

此文档是对用户配置流量、CU、字数、存储等用量消耗提醒功能的说明

## 功能目标

1. 实时通知用户流量/用量消耗情况
2. 支持不同阈值的提醒（例如80%、100%）
3. 避免重复推送相同提醒
4. 提高用户对账户用量的可感知性与控制感

## 技术方案

此功能基于Server-Sent Events（SSE）实现，在用户执行相关消耗任务（例如消耗流量）时，推送用量消耗提醒到前端。其技术优势如下：

1. 单向推送：服务端主动推送消息到客户端，适合通知场景
2. 轻量级：基于 HTTP 协议，无需 WebSocket 的复杂握手
3. 自动重连：浏览器原生支持断线重连
4. 兼容性好：主流浏览器均支持 EventSource API

## 架构设计

```
┌─────────────┐         ┌──────────────┐         ┌─────────────┐
│   前端页面   │ ◄─SSE─── │  SSE Manager  │ ◄───── │ 业务服务层  │
│ (EventSource)│         │ (连接管理器)  │         │(流量检查等) │
└─────────────┘         └──────────────┘         └─────────────┘
      │                         │                         │
      │ 1. 建立SSE连接          │                         │
      │─────────────────────────►                         │
      │                         │ 2. 注册用户连接         │
      │                         │                         │
      │ 3. 接收实时消息         │                         │
      │◄─────────────────────────                         │
      │                         │ 4. 业务触发通知         │
      │                         │◄────────────────────────│
      │                         │ 5. 推送消息到用户       │
      │◄─────────────────────────                         │
```

## 接口说明

### SSE连接接口

**Endpoint**: `GET /v1/usage/stream?user_id={user_id}`

**请求参数**:

- `user_id`: 用户ID (必填)

**请求头**:

- `Content-Type`: `text/event-stream`

## 实现流程

### 1. 流量统计流程

1. **中间件拦截**: `TrafficStats` 中间件拦截请求，统计流量使用
2. **流量记录**: 将流量数据记录到 `traffic_logs` 表
3. **更新用量**: 更新用户订阅表中的 `traffic_used` 字段
4. **触发检查**: 异步调用 `CheckAndSendTrafficNotification`

### 2. 通知发送流程

1. **计算使用率**: 根据用户套餐计算流量使用率百分比
2. **阈值检查**:
    - 80%预警：首次达到80%时发送通知
    - 100%限制：首次达到100%时发送通知
3. **状态更新**: 更新数据库中的预警标记，避免重复发送
4. **SSE推送**: 通过SSE连接实时推送通知到前端

### 3. 连接管理流程

1. **建立连接**: 前端通过EventSource建立SSE连接
2. **注册管理**: SSE管理器注册用户连接，维护userId到channel的映射
3. **心跳机制**: 每30秒发送心跳包，防止代理服务器关闭连接
4. **消息推送**: 根据userId找到对应channel发送消息
5. **连接清理**: 连接关闭时自动清理相关资源

## 前端集成

### 基本使用

```javascript
// 建立SSE连接
const evtSource = new EventSource('/v1/usage/stream?user_id=123');

// 接收消息
evtSource.onmessage = function (event) {
    console.log('收到通知:', event.data);
    // 显示通知给用户
    showNotification(event.data);
};

// 错误处理
evtSource.onerror = function (err) {
    console.error('SSE连接错误:', err);
};
```