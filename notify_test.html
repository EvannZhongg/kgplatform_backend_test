<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>SSE æµé‡æé†’æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
        }

        h1 {
            color: #333;
        }

        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            max-width: 600px;
            height: 300px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }

        .msg {
            margin-bottom: 10px;
            padding: 5px 10px;
            background-color: #e1f5fe;
            border-radius: 4px;
        }

        .login-panel {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-width: 600px;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: inline-block;
            width: 100px;
        }

        .form-group input {
            padding: 5px;
            width: 300px;
        }

        button {
            padding: 5px 15px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h1>SSE æµé‡æé†’æµ‹è¯•</h1>
<div class="login-panel">
    <h3>ç”¨æˆ·ç™»å½•</h3>
    <div class="form-group">
        <label for="loginUsername">ç”¨æˆ·å:</label>
        <input type="text" id="loginUsername" value="testuser"/>
    </div>
    <div class="form-group">
        <label for="loginPassword">å¯†ç :</label>
        <input type="password" id="loginPassword" value="123456"/>
    </div>
    <button id="loginBtn">ç™»å½•è·å–Token</button>
    <div id="tokenStatus"></div>
</div>

<div id="sse-panel">
    <button id="connectBtn">è¿æ¥ SSE</button>
    <div id="messages"></div>
</div>

<script>
    let evtSource;
    let jwtToken = null;

    // ç™»å½•è·å–JWT Token
    document.getElementById('loginBtn').addEventListener('click', async function () {
        const username = document.getElementById('loginUsername').value;
        const password = document.getElementById('loginPassword').value;
        const tokenStatus = document.getElementById('tokenStatus');

        if (!username || !password) {
            alert("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ");
            return;
        }

        try {
            const response = await fetch('http://localhost:8000/v1/users/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    password: password
                })
            });

            const data = await response.json();
            if (response.ok && data.code === 0 && data.data && data.data.token) {
                jwtToken = data.data.token;
                tokenStatus.textContent = 'âœ… ç™»å½•æˆåŠŸï¼Œå·²è·å–Token';
                tokenStatus.style.color = 'green';
                document.getElementById('connectBtn').disabled = false;
            } else {
                tokenStatus.textContent = 'âŒ ç™»å½•å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                tokenStatus.style.color = 'red';
                jwtToken = null;
                document.getElementById('connectBtn').disabled = true;
            }
        } catch (error) {
            tokenStatus.textContent = 'âŒ ç™»å½•è¯·æ±‚å‡ºé”™: ' + error.message;
            tokenStatus.style.color = 'red';
            jwtToken = null;
            document.getElementById('connectBtn').disabled = true;
        }
    });

    // è¿æ¥SSE
    document.getElementById('connectBtn').addEventListener('click', function () {
        if (!jwtToken) {
            alert("è¯·å…ˆç™»å½•è·å–Token");
            return;
        }

        // å¦‚æœå·²è¿æ¥ï¼Œå…ˆå…³é—­
        if (evtSource) {
            evtSource.close();
        }

        const url = 'http://localhost:8000/v1/usage/stream';
        // åˆ›å»ºSSEè¿æ¥æ—¶æ·»åŠ Authorizationå¤´
        evtSource = new EventSource(url, {
            headers: {
                'Authorization': jwtToken
            }
        });

        const messagesDiv = document.getElementById('messages');
        messagesDiv.innerHTML = '';

        evtSource.onopen = function () {
            const div = document.createElement('div');
            div.className = 'msg';
            div.textContent = 'âœ… SSE è¿æ¥å·²å»ºç«‹';
            messagesDiv.appendChild(div);
        };

        evtSource.onmessage = function (event) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.textContent = `ğŸ“¢ æ¶ˆæ¯: ${event.data}`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        };

        evtSource.onerror = function (err) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.style.backgroundColor = '#ffcdd2';
            div.textContent = 'âš  SSE è¿æ¥å‡ºé”™æˆ–å·²æ–­å¼€';
            messagesDiv.appendChild(div);
            evtSource.close();
        };
    });

    // åˆå§‹çŠ¶æ€ç¦ç”¨è¿æ¥æŒ‰é’®
    document.getElementById('connectBtn').disabled = true;
</script>
</body>
</html>